.TH qmail-smtpd 8
.SH NAME
qmail-smtpd \- receive mail via SMTP
.SH SYNOPSIS
.B qmail-smtpd
[
.I hostname
.I checkprogram
.I subprogram
]
.SH DESCRIPTION
.B qmail-smtpd
receives mail messages via the Simple Mail Transfer Protocol (SMTP)
and invokes
.B qmail-queue
to deposit them into the outgoing queue.
.B qmail-smtpd
must be supplied several environment variables;
see
.BR tcp-environ(5) .

.B qmail-smtpd
is responsible for counting hops.
It rejects any message with 100 or more 
.B Received
or
.B Delivered-To
header fields.

.B qmail-smtpd
has been modified to include many capabilities which are not present in
a standard qmail installation. The modifications are briefly described
below, or you can visit the web page listed at the end of this document
for a more complete description of how this version of qmail-smtpd differs
from the standard qmail-smtpd.

.B qmail-smtpd
supports ESMTP, including the 8BITMIME, PIPELINING, and AUTH options.

.B qmail-smtpd
can accept LOGIN, PLAIN, and optionally CRAM-MD5 AUTH types.  It invokes
.IR checkprogram ,
which reads on file descriptor 3 the username, a 0 byte, the password
or CRAM-MD5 response derived from
.IR hostname ,
another 0 byte, a CRAM-MD5 challenge (if applicable to the AUTH type),
and a final 0 byte.
.I checkprogram
invokes
.I subprogram
upon successful authentication, which should in turn return 0 to
.BR qmail-smtpd ,
effectively setting the environment variables RELAYCLIENT and TCPREMOTEINFO
(any supplied value replaced with the authenticated username).
.B qmail-smtpd
will reject the authentication attempt if it receives a nonzero return
value from
.I checkprogram
or
.IR subprogram .
.SH TRANSPARENCY
.B qmail-smtpd
converts the SMTP newline convention into the UNIX newline convention
by converting CR LF into LF.
It returns a temporary error and drops the connection on bare LFs;
see
.BR http://pobox.com/~djb/docs/smtplf.html .

.B qmail-smtpd
accepts messages that contain long lines or non-ASCII characters,
even though such messages violate the SMTP protocol.
.SH "CONTROL FILES"
.TP 5
.I badhelo
Unacceptable HELO/EHLO host names.
.B qmail-smtpd
will reject every recipient address for a message if
the host name is listed in, 
or matches a POSIX regular expression pattern listed in,
.IR badhelo .
If the 
.B NOBADHELO 
environment variable is set, then the contents of 
.IR badhelo 
will be ignored.
If the
.B LOGREGEX
environment variable is set, then the log entry generated by a match
will include the regular expression which was matched.
For more information, please have a look at doc/README.qregex.
.TP 5
.I badmailfrom
Unacceptable envelope sender addresses.
.B qmail-smtpd
will reject every recipient address for a message
if the envelope sender address is listed in, or matches a POSIX regular expression
pattern listed in,
.IR badmailfrom .
A line in
.I badmailfrom
may be of the form
.BR @\fIhost ,
meaning every address at
.IR host .
If the
.B LOGREGEX
environment variable is set, then the log entry generated by a match
will include the regular expression which was matched.
For more information, please have a look at doc/README.qregex.
.TP 5
.I badmailfromnorelay
Functions the same as the
.IR badmailfrom
control file but is read only if the 
.B RELAYCLIENT 
environment variable is not set.
For more information, please have a look at doc/README.qregex.
.TP 5
.I badrcptto
Unacceptable envelope recipient addresses.
.B qmail-smtpd
will reject every recipient address for a message if the recipient address
is listed in,
or matches a POSIX regular expression pattern listed in,
.IR badrcptto .
If the
.B LOGREGEX
environment variable is set, then the log entry generated by a match
will include the regular expression which was matched.
For more information, please have a look at doc/README.qregex.
.TP 5
.I badrcpttonorelay
Functions the same as the
.IR badrcptto
control file but is read only if the
.B RELAYCLIENT
environment variable is not set (and the client has not done a successful
AUTH command.)
For more information, please have a look at doc/README.qregex.
.TP 5
.I databytes
Maximum number of bytes allowed in a message,
or 0 for no limit.
Default: 0.
If a message exceeds this limit,
.B qmail-smtpd
returns a permanent error code to the client;
in contrast, if
the disk is full or
.B qmail-smtpd
hits a resource limit,
.B qmail-smtpd
returns a temporary error code.

.I databytes
counts bytes as stored on disk, not as transmitted through the network.
It does not count the
.B qmail-smtpd
Received line, the
.B qmail-queue
Received line, or the envelope.

If the environment variable
.B DATABYTES
is set, it overrides
.IR databytes .
In addition, the environment variable is re-checked after a successful 
AUTH command, which makes it possible to change its value using an 
AUTH_SET_DATABYTES environment variable.
.TP 5
.I localiphost
Replacement host name for local IP addresses.
Default:
.IR me ,
if that is supplied.
.B qmail-smtpd
is responsible for recognizing dotted-decimal addresses for the
current host.
When it sees a recipient address of the form
.IR box@[d.d.d.d] ,
where
.I d.d.d.d
is a local IP address,
it replaces
.IR [d.d.d.d]
with
.IR localiphost .
This is done before
.IR rcpthosts .
.TP 5
.I maxrcpt
If this file exists and contains a non-zero value, qmail-smtpd will
not accept more than this number of recipients for any single
message.

This value may be overridden using the
.B MAXRCPT
environment variable, which may itself be changed in the event of
a successful AUTH command using an
.B AUTH_SET_MAXRCPT
environment variable.
.TP 5
.I mfcheck
If this file exists and contains a non-zero value, the MAIL FROM
argument will be checked to make sure that the domain portion has
an MX record. This can help prevent spammers using bogus return
addresses. If the value is greater than 1, the results of this check
will be logged.

If the environment variable
.B MFCHECK
is set, its value overrides the value in this file. In addition, the 
environment variable is re-checked after a successful AUTH command, 
which makes it possible to change its value using an AUTH_SET_MFCHECK 
environment variable.
.TP 5
.I morercpthosts
Extra allowed RCPT domains.
If
.I rcpthosts
and
.I morercpthosts
both exist,
.I morercpthosts
is effectively appended to
.IR rcpthosts .

You must run
.B qmail-newmrh
whenever
.I morercpthosts
changes.

Rule of thumb for large sites:
Put your 50 most commonly used domains into
.IR rcpthosts ,
and the rest into
.IR morercpthosts .
.TP 5
.I rcpthosts
Allowed RCPT domains.
If
.I rcpthosts
is supplied,
.B qmail-smtpd
will reject
any envelope recipient address with a domain not listed in
.IR rcpthosts .

Exception:
If the environment variable
.B RELAYCLIENT
is set,
.B qmail-smtpd
will ignore
.IR rcpthosts ,
and will append the value of
.B RELAYCLIENT
to each incoming recipient address.

.I rcpthosts
may include wildcards:

.EX
   heaven.af.mil
   .heaven.af.mil
.EE

Envelope recipient addresses without @ signs are
always allowed through.
.TP 5
.I smtpgreeting
SMTP greeting message.
Default:
.IR me ,
if that is supplied;
otherwise
.B qmail-smtpd
will refuse to run.
The first word of
.I smtpgreeting
should be the current host's name.

Note that this value can be overridden by setting an
.B SMTPGREETING environment variable.
.TP 5
.I spfbehavior
Set to a value between 1 and 6 to enable SPF checks; 0 to disable.
1 selects 'annotate-only' mode, where
.B qmail-smtpd
will annotate incoming email with
.B Received-SPF
fields, but will not reject any messages.  2 will produce temporary
failures on DNS lookup problems so you can make sure you always have
meaningful Received-SPF headers.  3 selects 'reject' mode,
where incoming mail will be rejected if the SPF record says 'fail'.  4
selects a more stricter rejection mode, which is like 'reject' mode,
except that incoming mail will also be rejected when the SPF record
says 'softfail'.  5 will also reject when the SPF record says 'neutral',
and 6 if no SPF records are available at all (or a syntax error was
encountered). The contents of this file are overridden by the value of
the
.B SPFBEHAVIOR
environment variable, if set.
Default: 0.

Note that the environment variable is re-checked after a successful AUTH
command, which makes it possible to change its value using an
AUTH_SET_SPFBEHAVIOR environment variable.
.TP 5
.I spfexp
You can add a line with a an SPF explanation that will be shown to the
sender in case of a reject. It will override the default one. You can
use SPF macro expansion.
.TP 5
.I spfguess
You can add a line with SPF rules that will be checked if a sender
domain doesn't have a SPF record. The local rules will also be used
in this case.
.TP 5
.I spfrules
You can add a line with SPF rules that will be checked before other SPF
rules would fail.  This can be used to always allow certain machines to
send certain mails.
.TP 5
.I servercert.pem
This file should contain a PEM-encoded key and certificate which will be
used in order to create the server end of an SSL connection when processing
the STARTTLS command. This file should be readable by
.B qmail-smtpd
but not readable to the entire world.

Note that this filename may be overridden by setting a
.B TLS_SERVER_CERT environment variable.
.TP 5
.I timeoutsmtpd
Number of seconds
.B qmail-smtpd
will wait for each new buffer of data from the remote SMTP client.
Default: 1200.
.TP 5
.SH "ENVIRONMENT VARIABLES"
There are several environment variables which may be set in order to
modify how qmail-smtpd works.
.TP 5
.I ALLOW_CRAM
The CRAM-MD5 authentication method is not normally supported, because it
requires the server to have a list of plain-text passwords.
.B This is a bad thing.
However, if you understand the problem and are willing to accept the risk
that somebody cracking into your server might get all of your mailbox
passwords very easily, you can set this variable to a non-zero value and
.B qmail-smtpd
will advertise and support CRAM-MD5 as an authentication method.

This option also requires that your checkpassword program know how to
process a CRAM authentication request. The
.B vchkpw
program, part of the vpopmail package (version 5.4 and above) is able 
to handle CRAM-MD5 if you compile it with the option to store plain-text 
passwords. Earlier versions of vpopmail had a bug where it was reading 
the challenge and response in the wrong order, because the original SMTP 
AUTH patch sent the values in the wrong order. The 
.B 6c
version of the combined patch (described at the end of this document) fixed
the order.
.TP 5
.I ALLOW_INSECURE_AUTH
The AUTH command is not normally advertised in response to the EHLO
command, or accepted from the client, unless the connection is known to be
secure (because STARTTLS has been successfully processed, or because the
.B SSL
environment variable has a non-zero value.) Setting
.B ALLOW_INSECURE_AUTH
to a non-zero value will make
.B qmail-smtpd
advertise the AUTH capabilities in the EHLO response, and accept the
AUTH command from the client, regardless of whether or not the connection
is secure.

.B This is a very bad idea.
This allows your users to send their passwords across the Internet in
plain text when they AUTH in order to relay outbound mail. Anybody with
a packet sniffer could get your user's password, and then have their way
with the user's mailbox, or anything else where the user may be using
the same password. They would also be able to use that password to use
your server as a relay for spam...
.TP 5
.I AUTH_CDB
If present, this variable contains the name of a cdb file which contains
valid userid/password combinations to satisfy the AUTH command. Each key
in this file should be a valid system userid, virtual email address, or
other value which passes for a "userid" in the AUTH command. The value
linked to each key should be the ENCRYPTED password for that userid.

Note that the passwords in this file MUST BE ENCRYPTED using an encryption
or hashing method supported by your system's
.B crypt(3)
function. This is almost always the same set of encryption methods used
for the system's password database.
.TP 5
.I AUTH_SET_ and AUTH_UNSET_
When the first DATA command is sent during a session, if any environment
variables with names like AUTH_SET_{something} exist, a corresponding 
environment variable called {something} will be created with the value 
from the AUTH_SET_{something} variable, or if such a variable already 
exists, the existing value will be replaced with the new value. In 
either case, the AUTH_SET_{something} variable will then be deleted.

At the same time, if any environment variables with names like
AUTH_UNSET_{something} exist, any existing environment variable called
{something} will be deleted from the environment, and then the 
AUTH_UNSET_{something} variable will be deleted.

These types of variables can be useful in situations where changes need 
to be made to the environment when a user successfully sends an AUTH 
command, in order to modify the behavior of a program called through the
.B QMAILQUEUE
mechanism (see below.)
.TP 5
.I DENY_TLS
Setting this variable to a non-zero value will cause qmail-smtpd to not
support the STARTTLS command under any circumstances.

This value is internally set to 1 if the
.B servercert.pem
control file (or whatever filename the
.B TLS_SERVER_CERT
variable points to) is not present or not readable.
.TP 5
.I DROP_PRE_GREET
Many spammers will try to send commands to SMTP servers before the server
has sent its inital greeting, even though this violates RFC 821. Setting
this variable to a non-zero value will cause
.b qmail-smtpd
to pause for one second before sending the initial greeting, and drop any
client connection which tries to send commands before the greeting has
been sent.

Note that if you also use the
.B GREETDELAY
variable, the one second delay that DROP_PRE_GREET uses is taken from that
number- so the value of GREETDELAY will be the total used by both features.
.TP 5
.I FORCE_TLS
Setting this variable to a non-zero value will cause
.B qmail-smtpd
not to accept the MAIL FROM command unless STARTTLS has been successfully
processed. This makes it possible to create an SMTP server which can only
be used by authorized users.

.B WARNING: do not do this for a standard port 25 SMTP service
which handles incoming mail for any real domains, or you will prevent the
domain from being able to receive any mail unless it happens to come from
one of your authorized users.

This value is internally set to zero if the
.B SSL
environment variable is set to a non-zero value.

If you try to combine
.B FORCE_TLS
with
.B DENY_TLS
(either by manually setting the
.B DENY_TLS
variable, or by not having a readable
.B servercert.pem
control file) the client will receive an error message and
.B qmail-smtpd
will exit without accepting any message from the client.
.TP 5
.I GREETDELAY
Many spammers use programs which will give up on an SMTP server if
the server answers but doesn't send its initial banner in a timely
manner. However, legitimate mail servers will wait for the banner.
If you set this variable to a non-zero value,
.B qmail-smtpd
will pause that many seconds before sending the banner.

Note that if you also use the
.B DROP_PRE_GREET
variable, the extra one-second delay that DROP_PRE_GREET introduces
is taken from this total, so that if both variables are used, the
value of GREETDELAY is the total delay introduced by both features.
.TP 5
.I LOGREGEX
The badhelo, badmailfrom, badmailfromnorelay, badrcptto, and
badrcpttonorelay control files contain regular expressions which will
cause HELO, MAIL FROM, or RCPT TO commands whose arguments match a
pattern listed in the file to be rejected.

If this variable exists, the log messages generated by these mecahnisms
will include the regular expression which was matched.
.TP 5
.I MAXRCPT
If this variable is set, its value will override the value from the
.B maxrcpt
control file. It sets the maximum number of recipients for any one
message.

This variable is re-checked after a successful AUTH command, which
makes it possible to change its value using an AUTH_SET_MAXRCPT
environment variable.
.TP 5
.I MFCHECK
If this variable is set and has a non-zero value, the MAIL FROM
argument will be checked to make sure that the domain portion has
an MX record. This can help prevent spammers using bogus return
addresses. Note that this is the same check which is done if the
.b mfcheck
control file contains a non-zero value, although the value in the
environment variable overrides the value in the file.

If the value is greater than 1, the results of this check will be
logged.

This variable is re-checked after a successful AUTH command, which
makes it possible to change its value using an AUTH_SET_MFCHECK
environment variable.
.TP 5
.I PASSWORD_EXPIRES
If this variable is set, it is expected to contain a unix time() value (the
number of seconds since 1970-01-01 00:00:00 GMT.) If the current time is
equal to or greater than this value, any AUTH command will fail with an
error message saying that the password is expired.

Logically, this variable should only be used on a per-user basis. The
AUTH_CDB patch allows you to create environment variables which are
created when a specific user sends a successful AUTH command. Otherwise,
there is currently no other way to set this on a per-user basis.
.TP 5
.I QMAILQUEUE
If this variable is set, it should point to a program which will be 
executed instead of the
.B qmail-queue
program, in order to add a received message to the queue. This program 
should read its input and return the values exactly as the original
.B qmail-queue
program does. This version of the patch adds two additional return 
values which are not present in the original
.B qmail-queue
program:
.RS 5
.TP 5
.B 1
Tells the remote SMTP client "Your spam has been ignored", with the same 
status code as a successful delivery. This tells the remote SMTP client 
that the message was delivered, while in fact the message was not added 
to the queue. This can be used in cases where you know the message is 
SPAM and you know that if you refuse the message, the remote SMTP client 
is only going to keep trying over and over.
.TP 5
.B 32
Tells the remote SMTP client "we do not accept SPAM", with a status code 
indicating permanent refusal of the message (i.e. a "hard error".) This 
can be used if you know that the message is SPAM and want this message 
to show up in the remote server's log (instead of the standard "mail 
server permanently rejected message" caused by return value 31.)
.RE
.TP 5
.I RCPTCHECK
If this variable exists, it should contain the full pathname to a
program which
.B qmail-smtpd
will run after receiving each
.B RCPT
command.

No arguments are passed on the command line; before running the program,
.B qmail-smtpd
will store the recipient address sent by the client in the
.B RECIPIENT
environment variable, and the sender address (from the
.B MAIL
command) in the
.B SENDER
variable. Any other environment variables which were present when
.B qmail-smtpd
started, as possibly modified by the
.B AUTH_SET
mechanism, will be present as well. Note that this includes the
.B TCPREMOTEIP
variable, set by tcpserver, which will contain the client's IP address.

The exit code of the program determines whether or not
.B qmail-smtpd
will accept the command. The possible values are:
.RS 5
.TP 5
.B 100
The recipient is not valid. The client receives a 553 error.
.TP 5
.B 111
Temporary problem verifying the recipient. The client receives a 421
error code and the connection is closed.
.TP 5
.B 120
The program could not execute correctly. The client receives a 421 error
code and the connection is closed.
.TP 5
.B anything else
The recipient is valid.

.RE
.RS 5
Anything the program may send to its standard out or standard error
channel will be sent to the SMTP service's logs, just as if
.B qmail-smtpd
had printed it. This allows your program to log what it's doing.

This variable may be modified using the
.B AUTH_SET
mechanism if you want to bypass recipient checking, or use a different
program, for clients who have sent a valid AUTH command. However, I
recommend you write your program to check the
.B SMTP_AUTH_USER
variable instead- if a valid AUTH command has been sent, this variable
will contain the userid from that command.

This functionality (calling an external program in response to an AUTH
command) comes from Jay Soffian's RCPTCHECK patch, and is more fully
documented on his web site:
.IP
http://www.soffian.org/downloads/qmail/qmail-smtpd-doc.html

.RE
.TP 5
.I RELAYCLIENT
If this variable exists when
.B qmail-smtpd
starts, the remote SMTP client will be allowed to relay mail, ignoring 
the
.B rcpthosts
and
.B morercpthosts.cdb
files. This is normally only done for IP addresses which belong to you 
or your clients, and which could not be used by anybody who should not 
be authorized to relay. Some sites don't use this at all, preferring to 
grant relay access only to users who send a successful AUTH command.
.TP 5
.I RELAYREJ
If this variable exists and has a non-zero value,
.B qmail-smtpd
will do a sanity check each recipient address, to ensure that the
address does not contain multiple "@" characters, or that it does not
contain any "%" or "!" characters before the "@" character.

This check is only useful when dealing with broken relay testers that
try to use these characters to trigger old sendmail bugs and force your
server to be an open relay. Without these checks, qmail-smtpd may accept
messages but then not be able to deliver them- however some broken relay
testers consider this to be evidence of an open relay.

This check is normally not needed, and in fact it can break some types
of gateway systems (such as SMTP-to-UUCP.) However, some people seem to
get a warm fuzzy feeling if they know that it's being done, so I've
included it for their benefit.
.B Please don't use it.

This variable is re-checked after a successful AUTH command, which
makes it possible to change its value using an AUTH_SET_RELAYREJ
environment variable.
.TP 5
.I REQUIRE_AUTH
Setting this variable to a non-zero value will cause
.B qmail-smtpd
to not accept the MAIL FROM command until the user has successfully
authenticated (using the AUTH command.) Note that this may be combined
with
.B FORCE_TLS
to create a secure server which your users can use to relay mail.

If you try to set this without properly specifying an authentication
program on the command line, the client will receive an error message and
.B qmail-smtpd
will exit without accepting any message from the client.
.TP 5
.I SMTP_AUTH_USER
When the remote SMTP client sends a successful AUTH command, the
.B SMTP_AUTH_USER
variable will be set to the userid from the credentials. This variable 
can be tested by any scripts called through the
.B QMAILQUEUE
mechanism to determine whether or not the remote SMTP client has sent a 
successful AUTH command or not.
.TP 5
.I QMAILSMTPD_HELP_VERSION
If this variable is set to a non-zero value, the output of the HELP command
will include the version and URL of the jms1 combined patch you are using.

Note that this variable is re-checked after a successful AUTH command,
which makes it possible to change its value using an
AUTH_SET_QMAILSMTPD_HELP_VERSION environment variable.
.TP 5
.I QMAILSMTPD_LOG_MAIL
If this variable is set to a non-zero value, qmail-smtpd will log the sender
addresses specified in all successful MAIL FROM commands received from the
client.
.TP 5
.I QMAILSMTPD_LOG_RCPT
If this variable is set to a non-zero value, qmail-smtpd will log the
recipient addresses specified in all successful RCPT TO commands received
from the client.
.TP 5
.I SMTPGREETING
This variable overrides the value stored in the
.B smtpgreeting
control file (see above.)
.TP 5
.I SPFBEHAVIOR
This variable overrides the value stored in the
.B spfbehavior
control file (see above.)

Note that this variable is re-checked after a successful AUTH command,
which makes it possible to change its value using an
AUTH_SET_SPFBEHAVIOR environment variable.
.TP 5
.I SPF_BLOCK_PLUS_ALL
Setting this variable to a non-zero value will cause any "+all" term 
found in a domain's SPF record to be interpreted as if it said
"-all". This can be useful if you have a problem with spammers who have 
discovered that by creating an SPF record with "+all" in it, they can 
basically "walk around" any SPF-based filtering you may be doing.

This variable is checked during the SPF check, which happens after the 
client sends a MAIL FROM command. This makes it possible to change its 
value using an AUTH_SET_SPF_BLOCK_PLUS_ALL environment variable.
.TP 5
.I SPF_LOG
Setting this variable to a non-zero value will cause the result of every
SPF check to be logged. The log entries will be identical to the
"Received-SPF" header which is added to each incoming message.

This variable is re-checked after a successful AUTH command, which
makes it possible to change its value using an AUTH_SET_SPF_LOG
environment variable.
.TP 5
.I SSL
This variable should be set to a non-zero value if the SMTP service is
running
.B qmail-smtpd
under an SSL-secured socket. This tells
.B qmail-smtpd
that the connection is secure, which enables the AUTH command and disables
the STARTTLS command.
.TP 5
.I TCPREMOTEINFO
This variable is normally set by
.B tcpserver
if run without the -R option, and will contain the data (if any) 
returned by the
.B identd
service on the remote SMTP client's IP address. A successful AUTH 
command will add or replace this value with the userid which was part of 
the credentials. The data is the same as what you would find in the
.B SMTP_AUTH_USER
variable, with the exception that this variable may exist without a 
successful AUTH command.
.TP 5
.I TLS_SERVER_CERT
This variable contains the name of a file, which contains a PEM-encoded
private key and certificate used to encrypt the connection if a STARTTLS
command is received. If this variable is not present, the default name
.B control/servercert.pem
will be used.

Note that if you wish to set up a service which will not accept the
STARTTLS command at all, you may either remove whatever file this variable
(or the default value) points to, or you can create a
.B DENY_TLS
environment variable with a non-zero value.
.TP 5
.I VALIDRCPTTO_CDB
If this variable is present and not empty, qmail-smtpd will expect it to
contain the name of a cdb file. qmail-smtpd will check the argument of every
RCPT command against this file. It searches the file for a key which matches
the RCPT command. If a key is not found, the RCPT command will be rejected.
If a key is found, the RCPT command may be accepted or rejected, depending
on the value (if any) attached to that key.

qmail-smtpd searches first for a key which matches the argument to the
RCPT command. If the address sent by the client is not found, and if the
mailbox portion of the address (the part to the left of the "@" sign)
contains one or more of qmail's "ext" character (usually "-", ASCII 45)
it will search for any appropriate entries of the form
.B user-default@domain
going from more to less specific, with
.B @domain
as a final resort.

For example, if the address sent is
.B user-one-two-three@domain,
it will search for the following items:

.EX
   user-one-two-three@domain
   user-one-two-default@domain
   user-one-default@domain
   user-default@domain
   @domain
.EE

The first key key it finds while searching is what will be used.

Once an appropriate key is found, the value (if any) attached to that key
is checked. If the key has no value (as will be the case if you are using
an older version of the validrcptto.cdb patch) then the address will be
accepted. If there is a value attached, and if the first byte of that
value is a hyphen (i.e. "-", ASCII 45) then the address will be rejected.
Values other than "-" are reserved for future versions of this patch and
should not be used.

In order to prevent "harvesting" attacks,
.B qmail-smtpd
counts how many invalid recipients have been attempted in each connection,
and when a certain limit is reached,
.B qmail-smtpd
will forcibly disconnect the client. This limit has a default 10, and can be
changed or disabled with the
.B VALIDRCPTTO_LIMIT
environment variable.

This variable is re-checked after a successful AUTH command, which makes
it possible to change its value using an AUTH_SET_VALIDRCPTTO_CDB
or AUTH_UNSET_VALIDRCPTTO_CDB environment variable.
.TP 5
.I VALIDRCPTTO_LIMIT
This variable sets the limit of how many invalid RCPT TO commands will be
treated as "soft errors". When this limit is reached,
.B qmail-smtpd
will forcibly disconnect from the client. The default limit is 10. Setting
this value to zero will disable the counting entirely, making it possible
for a spammer to "harvest" the valid email addresses on your server.

This variable is re-checked after a successful AUTH command, which makes
it possible to change its value using an AUTH_SET_VALIDRCPTTO_LIMIT
environment variable.
.TP 5
.I VALIDRCPTTO_LOG
Setting this variable to 1 will cause
.B qmail-smtpd
to log each RCPT TO command received from a client, along with what entry
from the
.B validrcptto.cdb
control file matched the address entered. If no match was found, that will
be logged as well. If a client is forcibly disconnected for trying more than
.B VALIDRCPTTO_LIMIT
invalid recipients, that will be logged as well.

Setting this variable to 2 will cause
.B qmail-smtpd
to also log everything it searches for within the
.B validrcptto.cdb
file. This can be useful when debugging a problem.

This variable is re-checked after a successful AUTH command, which makes
it possible to change its value using an AUTH_SET_VALIDRCPTTO_LOG
environment variable.
.SH "SEE ALSO"
tcp-env(1),
tcp-environ(5),
qmail-control(5),
qmail-inject(8),
qmail-newmrh(8),
qmail-queue(8),
qmail-remote(8)
.SH "HISTORY"
See
.B http://qmail.jms1.net/patches/combined-details.shtml
for more detailed information about the differences between this instance
of qmail and the stock qmail. This man page is current as of the
.B 7.10
version of the combined patch file.
